generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ASSOCIATE
}

enum LeadState {
  NEW
  NO_ANSWER
  CALL_LATER
  BOOKED
  REFUSED
  SKIP
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role     @default(ASSOCIATE)
  createdAt    DateTime @default(now())

  // rela√ß√£o que j√° tinhas (pendentes atribu√≠dos)
  contacts Contact[] @relation("AssignedContacts")

  // üëá novos ‚Äúlados opostos‚Äù
  sessions      CallSession[]  @relation("UserSessions")
  contactTimers ContactTimer[] @relation("UserContactTimers")
}

model Contact {
  id          String  @id @default(cuid())
  firstName   String?
  lastName    String?
  companyName String
  title       String?
  email       String?
  emailStatus String?
  phoneWork   String?
  phoneMobile String?
  phoneCorp   String?
  industry    String?
  keywords    String?
  website     String?
  companyCity String?

  state       LeadState @default(NEW)
  callNote    String?
  callLaterAt DateTime?
  noAnswerAt  DateTime?

  reviveAt      DateTime?
  noAnswerCount Int       @default(0)
  lastCalledAt  DateTime?

  assignedToId String?
  assignedTo   User?   @relation("AssignedContacts", fields: [assignedToId], references: [id])

  // üëá lado oposto que faltava
  timers ContactTimer[] @relation("ContactTimers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // (opcional mas √∫til)
  @@index([state])
  @@index([reviveAt])
}

model CallSession {
  id          String    @id @default(cuid())
  userId      String
  // üëá d√° nome √† rela√ß√£o e aponta o lado oposto em User.sessions
  user        User      @relation("UserSessions", fields: [userId], references: [id])
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  durationSec Int?

  // üëá liga aos timers desta sess√£o
  contactTimes ContactTimer[] @relation("SessionContactTimers")
}

model ContactTimer {
  id String @id @default(cuid())

  // üëá rela√ß√£o (opcional) para a sess√£o e respetivo lado oposto
  sessionId String?
  session   CallSession? @relation("SessionContactTimers", fields: [sessionId], references: [id])

  // üëá rela√ß√£o para o contacto e lado oposto em Contact.timers
  contactId String
  contact   Contact @relation("ContactTimers", fields: [contactId], references: [id])

  // üëá rela√ß√£o para o utilizador e lado oposto em User.contactTimers
  userId String
  user   User   @relation("UserContactTimers", fields: [userId], references: [id])

  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  durationSec Int?
}
